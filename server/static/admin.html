<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LawPro Admin Dashboard</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: var(--card);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .error-msg {
            color: var(--danger);
            text-align: center;
            margin-top: 15px;
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: var(--card);
            padding: 15px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            color: var(--primary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 60px;
            bottom: 0;
            width: 240px;
            background: var(--card);
            border-right: 1px solid var(--border);
            padding: 20px 0;
        }

        .nav-item {
            padding: 12px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text);
            transition: all 0.2s;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--bg);
            color: var(--primary);
            border-right: 3px solid var(--primary);
        }

        .main-content {
            margin-left: 240px;
            padding: 30px;
            min-height: calc(100vh - 60px);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Cards & Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
        }

        .stat-card .sub {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* Tables */
        .card {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            font-size: 18px;
        }

        .card-body {
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-weight: 600;
            color: var(--text-light);
            font-size: 14px;
        }

        tr:hover {
            background: var(--bg);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Config Form */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .config-item {
            background: var(--bg);
            padding: 20px;
            border-radius: 8px;
        }

        .config-item label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .config-item input, .config-item select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .config-item small {
            color: var(--text-light);
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }

        /* Search */
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h1>LawPro Admin</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>아이디</label>
                    <input type="text" id="username" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label>비밀번호</label>
                    <input type="password" id="password" placeholder="비밀번호" required>
                </div>
                <button type="submit" class="btn btn-primary">로그인</button>
                <p id="loginError" class="error-msg"></p>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <!-- Header -->
        <header class="header">
            <h1>LawPro Admin Dashboard</h1>
            <div class="user-info">
                <span id="adminName">관리자</span>
                <button class="btn btn-secondary btn-sm" onclick="logout()">로그아웃</button>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="nav-item active" data-page="overview">
                <span>대시보드</span>
            </div>
            <div class="nav-item" data-page="users">
                <span>회원 관리</span>
            </div>
            <div class="nav-item" data-page="patterns">
                <span>오류 패턴</span>
            </div>
            <div class="nav-item" data-page="corrections">
                <span>수정 내역</span>
            </div>
            <div class="nav-item" data-page="config">
                <span>설정</span>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Page -->
            <div id="page-overview" class="page active">
                <h2 style="margin-bottom: 20px;">대시보드</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>총 회원수</h3>
                        <div class="value" id="stat-users-total">-</div>
                        <div class="sub">활성: <span id="stat-users-active">-</span></div>
                    </div>
                    <div class="stat-card">
                        <h3>오늘 가입</h3>
                        <div class="value" id="stat-users-today">-</div>
                        <div class="sub">이번 주: <span id="stat-users-week">-</span></div>
                    </div>
                    <div class="stat-card">
                        <h3>총 변환</h3>
                        <div class="value" id="stat-conversions-total">-</div>
                        <div class="sub">오늘: <span id="stat-conversions-today">-</span></div>
                    </div>
                    <div class="stat-card">
                        <h3>총 페이지</h3>
                        <div class="value" id="stat-pages-total">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>오류 패턴</h3>
                        <div class="value" id="stat-patterns-total">-</div>
                        <div class="sub">이미지PDF: <span id="stat-patterns-image">-</span> / 디지털: <span id="stat-patterns-digital">-</span></div>
                    </div>
                    <div class="stat-card">
                        <h3>수정 내역</h3>
                        <div class="value" id="stat-corrections-total">-</div>
                        <div class="sub">확정: <span id="stat-corrections-confirmed">-</span></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>최근 활동</h2>
                    </div>
                    <div class="card-body">
                        <div id="recent-activity" class="loading">
                            <div class="spinner"></div>
                            로딩 중...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Page -->
            <div id="page-users" class="page">
                <h2 style="margin-bottom: 20px;">회원 관리</h2>

                <div class="search-box">
                    <input type="text" id="userSearch" placeholder="이메일 또는 이름으로 검색...">
                    <button class="btn btn-primary" onclick="searchUsers()">검색</button>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>이메일</th>
                                    <th>이름</th>
                                    <th>크레딧</th>
                                    <th>상태</th>
                                    <th>가입일</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                            </tbody>
                        </table>
                        <div id="usersPagination" class="pagination"></div>
                    </div>
                </div>
            </div>

            <!-- Patterns Page -->
            <div id="page-patterns" class="page">
                <h2 style="margin-bottom: 20px;">오류 패턴 관리</h2>

                <div class="search-box">
                    <input type="text" id="patternSearch" placeholder="오류 또는 정답으로 검색...">
                    <select id="patternSource" style="width: 150px;">
                        <option value="">전체 출처</option>
                        <option value="image_pdf">이미지 PDF</option>
                        <option value="digital_doc">디지털 문서</option>
                    </select>
                    <select id="patternSort" style="width: 150px;">
                        <option value="effectiveness">효과성순</option>
                        <option value="usage_count">사용횟수순</option>
                        <option value="frequency">제출횟수순</option>
                        <option value="created_at">최신순</option>
                    </select>
                    <button class="btn btn-primary" onclick="searchPatterns()">검색</button>
                    <button class="btn btn-secondary" onclick="openPatternModal()">패턴 추가</button>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>오류</th>
                                    <th>정답</th>
                                    <th>출처</th>
                                    <th>제출</th>
                                    <th>사용</th>
                                    <th>효과점수</th>
                                    <th>상태</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="patternsTable">
                            </tbody>
                        </table>
                        <div id="patternsPagination" class="pagination"></div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-danger" onclick="cleanupPatterns()">저사용 패턴 정리</button>
                </div>
            </div>

            <!-- Corrections Page -->
            <div id="page-corrections" class="page">
                <h2 style="margin-bottom: 20px;">수정 내역</h2>

                <div class="search-box">
                    <select id="correctionDecision" style="width: 150px;">
                        <option value="">전체 결정</option>
                        <option value="confirmed">확정</option>
                        <option value="rejected">거부</option>
                        <option value="modified">수정</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadCorrections()">필터</button>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>파일</th>
                                    <th>원본</th>
                                    <th>수정</th>
                                    <th>결정</th>
                                    <th>일시</th>
                                </tr>
                            </thead>
                            <tbody id="correctionsTable">
                            </tbody>
                        </table>
                        <div id="correctionsPagination" class="pagination"></div>
                    </div>
                </div>
            </div>

            <!-- Config Page -->
            <div id="page-config" class="page">
                <h2 style="margin-bottom: 20px;">설정</h2>

                <div class="card">
                    <div class="card-header">
                        <h2>LLM 패턴 제한 설정</h2>
                    </div>
                    <div class="card-body">
                        <div id="llmInfo" style="background: var(--bg); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <strong>현재 타겟 LLM:</strong> <span id="configTargetLlm">-</span><br>
                            <strong>컨텍스트 제한:</strong> <span id="configContextLimit">-</span> 토큰<br>
                            <strong>패턴당 토큰:</strong> <span id="configTokensPerPattern">-</span><br>
                            <strong>권장 최대 패턴:</strong> <span id="configRecommendedMax">-</span>개
                        </div>

                        <form id="configForm" class="config-grid">
                            <div class="config-item">
                                <label>타겟 LLM</label>
                                <select id="config-target_llm">
                                    <option value="gpt-4o">GPT-4o (128K)</option>
                                    <option value="gpt-4o-mini">GPT-4o-mini (128K)</option>
                                    <option value="gemini-2.0-flash">Gemini 2.0 Flash (1M)</option>
                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro (1M)</option>
                                    <option value="claude-3.5-sonnet">Claude 3.5 Sonnet (200K)</option>
                                </select>
                                <small>검수에 사용할 주 LLM 모델</small>
                            </div>

                            <div class="config-item">
                                <label>최대 패턴 수</label>
                                <input type="number" id="config-max_patterns" min="100" max="50000">
                                <small>저장할 최대 오류 패턴 수 (LLM 컨텍스트 기준)</small>
                            </div>

                            <div class="config-item">
                                <label>출처당 최대 패턴</label>
                                <input type="number" id="config-max_patterns_per_source" min="50" max="25000">
                                <small>이미지PDF/디지털문서 각각의 최대 패턴 수</small>
                            </div>

                            <div class="config-item">
                                <label>자동 정리 임계값</label>
                                <input type="number" id="config-cleanup_threshold" min="100" max="60000">
                                <small>이 수를 초과하면 자동으로 저사용 패턴 삭제</small>
                            </div>

                            <div class="config-item">
                                <label>프롬프트 패턴 수</label>
                                <input type="number" id="config-prompt_pattern_limit" min="10" max="500">
                                <small>AI 검수 프롬프트에 포함할 최대 패턴 수</small>
                            </div>

                            <div class="config-item">
                                <label>유지 최소 사용횟수</label>
                                <input type="number" id="config-min_usage_to_keep" min="0" max="100">
                                <small>정리 시 이 횟수 이상 사용된 패턴은 유지</small>
                            </div>
                        </form>

                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="saveConfig()">설정 저장</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Pattern Modal -->
    <div id="patternModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>오류 패턴 추가</h3>
                <button class="modal-close" onclick="closePatternModal()">&times;</button>
            </div>
            <form id="patternForm">
                <div class="form-group">
                    <label>오류 텍스트</label>
                    <input type="text" id="pattern-original" required placeholder="예: 계약Z">
                </div>
                <div class="form-group">
                    <label>정답 텍스트</label>
                    <input type="text" id="pattern-corrected" required placeholder="예: 계약을">
                </div>
                <div class="form-group">
                    <label>출처</label>
                    <select id="pattern-source" required>
                        <option value="image_pdf">이미지 PDF (OCR)</option>
                        <option value="digital_doc">디지털 문서 (라이브러리)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>카테고리</label>
                    <input type="text" id="pattern-category" placeholder="예: ocr_한영혼동">
                </div>
                <div class="form-group">
                    <label>이유</label>
                    <input type="text" id="pattern-reason" placeholder="예: OCR이 을을 Z로 인식">
                </div>
                <button type="submit" class="btn btn-primary">추가</button>
            </form>
        </div>
    </div>

    <script>
        // API 설정
        const API_BASE = window.location.origin;
        let authToken = localStorage.getItem('adminToken');

        // 페이지 상태
        let currentPage = {
            users: 1,
            patterns: 1,
            corrections: 1
        };

        // 인증 헤더
        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }

        // API 호출
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers: getHeaders()
                });

                if (response.status === 401) {
                    logout();
                    return null;
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                alert('API 오류: ' + error.message);
                return null;
            }
        }

        // 로그인
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.access_token;
                    localStorage.setItem('adminToken', authToken);
                    showDashboard();
                } else {
                    document.getElementById('loginError').textContent = data.detail || '로그인 실패';
                }
            } catch (error) {
                document.getElementById('loginError').textContent = '서버 연결 오류';
            }
        });

        // 로그아웃
        function logout() {
            localStorage.removeItem('adminToken');
            authToken = null;
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
        }

        // 대시보드 표시
        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            loadOverview();
        }

        // 네비게이션
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;

                // 활성 상태 변경
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                // 페이지 변경
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(`page-${page}`).classList.add('active');

                // 데이터 로드
                switch(page) {
                    case 'overview': loadOverview(); break;
                    case 'users': loadUsers(); break;
                    case 'patterns': loadPatterns(); break;
                    case 'corrections': loadCorrections(); break;
                    case 'config': loadConfig(); break;
                }
            });
        });

        // 개요 로드
        async function loadOverview() {
            const data = await apiCall('/api/admin/stats/overview');
            if (!data) return;

            document.getElementById('stat-users-total').textContent = data.users.total.toLocaleString();
            document.getElementById('stat-users-active').textContent = data.users.active.toLocaleString();
            document.getElementById('stat-users-today').textContent = data.users.new_today.toLocaleString();
            document.getElementById('stat-users-week').textContent = data.users.new_this_week.toLocaleString();

            document.getElementById('stat-conversions-total').textContent = data.conversions.total.toLocaleString();
            document.getElementById('stat-conversions-today').textContent = data.conversions.today.toLocaleString();

            document.getElementById('stat-pages-total').textContent = data.pages.total.toLocaleString();

            document.getElementById('stat-patterns-total').textContent = data.patterns.total.toLocaleString();
            document.getElementById('stat-patterns-image').textContent = data.patterns.image_pdf.toLocaleString();
            document.getElementById('stat-patterns-digital').textContent = data.patterns.digital_doc.toLocaleString();

            document.getElementById('stat-corrections-total').textContent = data.corrections.total.toLocaleString();
            document.getElementById('stat-corrections-confirmed').textContent = data.corrections.confirmed.toLocaleString();

            document.getElementById('recent-activity').innerHTML = '<p style="color: var(--text-light);">통계가 로드되었습니다.</p>';
        }

        // 사용자 로드
        async function loadUsers(page = 1) {
            currentPage.users = page;
            const search = document.getElementById('userSearch').value;
            const params = new URLSearchParams({ page, limit: 50 });
            if (search) params.append('search', search);

            const data = await apiCall(`/api/admin/users?${params}`);
            if (!data) return;

            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = data.users.map(user => `
                <tr>
                    <td>${user.email}</td>
                    <td>${user.name || '-'}</td>
                    <td>${user.credits || 0}</td>
                    <td><span class="badge ${user.is_active ? 'badge-success' : 'badge-danger'}">${user.is_active ? '활성' : '비활성'}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString('ko-KR')}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="toggleUserActive('${user.id}', ${!user.is_active})">${user.is_active ? '비활성화' : '활성화'}</button>
                    </td>
                </tr>
            `).join('');

            renderPagination('usersPagination', data.total_pages, page, loadUsers);
        }

        function searchUsers() {
            loadUsers(1);
        }

        async function toggleUserActive(userId, isActive) {
            await apiCall(`/api/admin/users/${userId}`, {
                method: 'PATCH',
                body: JSON.stringify({ is_active: isActive })
            });
            loadUsers(currentPage.users);
        }

        // 패턴 로드
        async function loadPatterns(page = 1) {
            currentPage.patterns = page;
            const search = document.getElementById('patternSearch').value;
            const source = document.getElementById('patternSource').value;
            const sortBy = document.getElementById('patternSort').value;

            const params = new URLSearchParams({ page, limit: 50, sort_by: sortBy });
            if (search) params.append('search', search);
            if (source) params.append('source', source);

            const data = await apiCall(`/api/admin/patterns?${params}`);
            if (!data) return;

            const tbody = document.getElementById('patternsTable');
            tbody.innerHTML = data.patterns.map(p => `
                <tr>
                    <td><code>${p.original}</code></td>
                    <td><code>${p.corrected}</code></td>
                    <td><span class="badge ${p.source === 'image_pdf' ? 'badge-info' : 'badge-warning'}">${p.source === 'image_pdf' ? '이미지PDF' : '디지털'}</span></td>
                    <td>${p.frequency}</td>
                    <td>${p.usage_count}</td>
                    <td><strong>${p.effectiveness_score}</strong></td>
                    <td><span class="badge ${p.is_active ? 'badge-success' : 'badge-danger'}">${p.is_active ? '활성' : '비활성'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="togglePatternActive('${p.id}', ${!p.is_active})">${p.is_active ? '비활성' : '활성'}</button>
                        <button class="btn btn-sm btn-danger" onclick="deletePattern('${p.id}')">삭제</button>
                    </td>
                </tr>
            `).join('');

            renderPagination('patternsPagination', data.total_pages, page, loadPatterns);
        }

        function searchPatterns() {
            loadPatterns(1);
        }

        async function togglePatternActive(patternId, isActive) {
            await apiCall(`/api/admin/patterns/${patternId}`, {
                method: 'PATCH',
                body: JSON.stringify({ is_active: isActive })
            });
            loadPatterns(currentPage.patterns);
        }

        async function deletePattern(patternId) {
            if (!confirm('이 패턴을 삭제하시겠습니까?')) return;

            await apiCall(`/api/admin/patterns/${patternId}`, { method: 'DELETE' });
            loadPatterns(currentPage.patterns);
        }

        async function cleanupPatterns() {
            if (!confirm('저사용 패턴을 정리하시겠습니까?')) return;

            const result = await apiCall('/api/admin/patterns/cleanup', { method: 'POST' });
            if (result) {
                alert(`정리 완료: ${result.deleted || 0}개 삭제됨`);
                loadPatterns(1);
            }
        }

        // 패턴 모달
        function openPatternModal() {
            document.getElementById('patternModal').classList.add('active');
        }

        function closePatternModal() {
            document.getElementById('patternModal').classList.remove('active');
            document.getElementById('patternForm').reset();
        }

        document.getElementById('patternForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const pattern = {
                original: document.getElementById('pattern-original').value,
                corrected: document.getElementById('pattern-corrected').value,
                source: document.getElementById('pattern-source').value,
                category: document.getElementById('pattern-category').value || 'unknown',
                reason: document.getElementById('pattern-reason').value || ''
            };

            const result = await apiCall('/api/admin/patterns', {
                method: 'POST',
                body: JSON.stringify(pattern)
            });

            if (result && result.success) {
                closePatternModal();
                loadPatterns(1);
                alert(`패턴 ${result.action === 'created' ? '추가' : '업데이트'}됨`);
            }
        });

        // 수정 내역 로드
        async function loadCorrections(page = 1) {
            currentPage.corrections = page;
            const decision = document.getElementById('correctionDecision').value;

            const params = new URLSearchParams({ page, limit: 50 });
            if (decision) params.append('decision', decision);

            const data = await apiCall(`/api/admin/corrections?${params}`);
            if (!data) return;

            const tbody = document.getElementById('correctionsTable');
            tbody.innerHTML = data.corrections.map(c => `
                <tr>
                    <td>${c.file_name || '-'}</td>
                    <td><code>${c.original}</code></td>
                    <td><code>${c.corrected}</code></td>
                    <td><span class="badge ${c.decision === 'confirmed' ? 'badge-success' : c.decision === 'rejected' ? 'badge-danger' : 'badge-warning'}">${c.decision}</span></td>
                    <td>${new Date(c.created_at).toLocaleString('ko-KR')}</td>
                </tr>
            `).join('');

            renderPagination('correctionsPagination', Math.ceil(data.total / 50), page, loadCorrections);
        }

        // 설정 로드
        async function loadConfig() {
            const data = await apiCall('/api/admin/config');
            if (!data) return;

            const config = data.config;
            const llm = data.llm_info;

            document.getElementById('configTargetLlm').textContent = llm.target_llm;
            document.getElementById('configContextLimit').textContent = llm.context_limit.toLocaleString();
            document.getElementById('configTokensPerPattern').textContent = llm.tokens_per_pattern;
            document.getElementById('configRecommendedMax').textContent = llm.recommended_max_patterns.toLocaleString();

            document.getElementById('config-target_llm').value = config.target_llm || 'gpt-4o';
            document.getElementById('config-max_patterns').value = config.max_patterns || 5000;
            document.getElementById('config-max_patterns_per_source').value = config.max_patterns_per_source || 2500;
            document.getElementById('config-cleanup_threshold').value = config.cleanup_threshold || 6000;
            document.getElementById('config-prompt_pattern_limit').value = config.prompt_pattern_limit || 100;
            document.getElementById('config-min_usage_to_keep').value = config.min_usage_to_keep || 0;
        }

        async function saveConfig() {
            const update = {
                target_llm: document.getElementById('config-target_llm').value,
                max_patterns: parseInt(document.getElementById('config-max_patterns').value),
                max_patterns_per_source: parseInt(document.getElementById('config-max_patterns_per_source').value),
                cleanup_threshold: parseInt(document.getElementById('config-cleanup_threshold').value),
                prompt_pattern_limit: parseInt(document.getElementById('config-prompt_pattern_limit').value),
                min_usage_to_keep: parseInt(document.getElementById('config-min_usage_to_keep').value)
            };

            const result = await apiCall('/api/admin/config', {
                method: 'PATCH',
                body: JSON.stringify(update)
            });

            if (result && result.success) {
                alert('설정이 저장되었습니다.');
                loadConfig();
            }
        }

        // 페이지네이션 렌더링
        function renderPagination(containerId, totalPages, currentPage, loadFunc) {
            const container = document.getElementById(containerId);
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            if (currentPage > 1) {
                html += `<button onclick="${loadFunc.name}(${currentPage - 1})">이전</button>`;
            }

            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="${loadFunc.name}(${i})">${i}</button>`;
            }

            if (currentPage < totalPages) {
                html += `<button onclick="${loadFunc.name}(${currentPage + 1})">다음</button>`;
            }

            container.innerHTML = html;
        }

        // 초기화
        if (authToken) {
            showDashboard();
        }
    </script>
</body>
</html>
